#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# music
# Description: Displays status item showing information about mpd server
# -----------------------------------------------------------------------------
# Requires:
#   mpd / mpc
#   xftwidth
#   dzen
# -----------------------------------------------------------------------------
# Usage:      $ ./music
# -----------------------------------------------------------------------------

# type and name the module
declare -A module
module['type']='status_item'
module['name']='mpd'

# make a directory to store temporary files
readonly temp_dir=$( mktemp -p "${TMPDIR}" -d "${USER}_${module['type']}_${module['name']}-XXXX" ) || exit 1
# name fifo after module name and store in temp_dir
readonly fifo="${temp_dir}/${module['name']}.fifo"

# Source color theme
source "$HOME/.bin/ui/colors"

# provides function update_status_item that draws a persistent status_item using dzen
#   name, x, y, width, height, stream, font, color_fg, color_bg --> void
#   Modifies status_item array
#   User must kill status_item['pid'] on cleanup
source "$HOME/.bin/ui/menu_bar/status_items/update_status_item"

# associative array for storing content to be displayed
declare -A content

#
#   color_fg, color_bg --> void
#   Modifies content array
# TODO: add bg formatting
function update_content() {
    # set colors
    local color_fg="$1"
    local color_artist="${color_blue}"
    local color_title="${color_yellow}"
    local color_album="${color_lightgrey}"

    # nothing is currently playing or paused
    if [[ -z "$(mpc current)" ]]; then
        content['raw']='Playlist Empty'
        content['formatted']="^fg(${color_fg})Playlist Empty"

    # something is playing or paused
    else
        # get individual mpc current fields for formatting
        local artist=$( mpc -f "[%artist%]" | head -n 1 )
        local title=$( mpc -f "[%title%]" | head -n 1 )
        local album=$( mpc -f "[%album%]" | head -n 1 )

        # has artist, title and album
        if [[ -n "${artist}" && -n "${title}" && -n "${album}" ]]; then
            content['raw']="${artist} - ${title} - ${album}"
            content['formatted']="^fg(${color_artist})${artist}^fg(${color_fg}) - ^fg(${color_title})${title}^fg(${color_fg}) - ^fg(${color_album})${album}"

        # has artist and title but not album
        elif [[ -n "${artist}" && -n "${title}" ]]; then
            content['raw']="${artist} - ${title}"
            content['formatted']="^fg(${color_artist})${artist}^fg(${color_fg}) - ^fg(${color_title})${title}"

        # has artist and album but not title
        elif [[ -n "${artist}" && -n "${album}" ]]; then
            content['raw']="${artist} - ${album}"
            content['formatted']="^fg(${color_artist})${artist}^fg(${color_fg}) - ^fg(${color_album})${album}"

        # has title and album but not artist
        elif [[ -n "${title}" && -n "${album}" ]]; then
            content['raw']="${title} - ${album}"
            content['formatted']="^fg(${color_title})${title}^fg(${color_fg}) - ^fg(${color_album})${album}"

        # has only artist
        elif [[ -n "${artist}" ]]; then
            content['raw']="${artist}"
            content['formatted']="^fg(${color_artist})${artist}"

        # has only title
        elif [[ -n "${title}" ]]; then
            content['raw']="${title}"
            content['formatted']="^fg(${color_title})${title}"

        # has only album
        elif [[ -n "${album}" ]]; then
            content['raw']="${album}"
            content['formatted']="^fg(${color_album})${album}"

        # no artist, title or album
        else
            content['raw']='Unknown'
            content['formatted']="^fg(${color_fg})Unknown"
        fi
    fi
}

function finish() {
    # kill the status_item
    kill "${status_item['pid']}"

    # remove the fifo
    rm "${fifo}"

    # remove temp fifo dir
    rmdir "${temp_dir}"
}

function main() {
    # monitor settings
    declare -A monitor
    monitor['width']='2880'
    monitor['height']='1800'
    monitor['padding']='40'

    # default x geometry
    declare -A geometry
    geometry['x']='0'
    geometry['y']='20'
    geometry['width']='0'
    geometry['height']='40'

    # default colors and font
    local font='Source Code Pro:size=7'
    declare -A color
    color['fg']="${color_lightgrey}"
    color['bg']="${color_black}"

    while
        :
    do
        # make the fifo
        if [[ ! -p "${fifo}" ]]; then
            mkfifo "${fifo}" || exit 1
        fi

        # modifies ${content['raw']} and ${content['formatted']}
        # color_fg, color_bg --> void
        update_content "${color['fg']}" "${color['bg']}"
        # update width and x_pos to reflect content
        geometry['width']=$(xftwidth "${font}" "-${content['raw']}-")
        geometry['x']="${monitor['padding']}"

        # modifies ${status_item[@]}
        # name, x, y, width, height, stream, font, color_fg, color_bg --> void
        update_status_item \
            "${module['type']}_${module['name']}" \
            "${geometry['x']}" "${geometry['y']}" "${geometry['width']}" "${geometry['height']}" \
            "${fifo}" "${font}" "${color['fg']}" "${color['bg']}"

        # pipe to fifo
        echo "${content['formatted']}" >"${fifo}"

        # wait for mpd player event
        mpc idle player >/dev/null
    done
}

# cleanup on exit
trap finish EXIT

# main
main "$@"
