#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# battery
# Description: Displays status item showing information about battery level
# -----------------------------------------------------------------------------
# Requires:
#   acpi
#   xftwidth
#   dzen
# -----------------------------------------------------------------------------
# Useage:      $ ./battery
# -----------------------------------------------------------------------------

# Source color theme
source "$HOME/.bin/ui/colors"

# Source monitors
source "$HOME/.bin/ui/menu_bar/status_items/monitor"

# provides function new_module(): creates module temp files
#   module_type, name --> void
#   Modifies module array, creates module temp files
# provides function free_module(): User must call on cleanup
#   void --> void
#   removes module temp files
# provides function get_module_type(), get_module_name(), get_module_directory(),
#   get_module_stream() which return module parameters
#   void --> string
source "$HOME/.bin/ui/menu_bar/status_items/module"

# provides function update_status_item: draws a persistent status_item using dzen
#   name, x, y, width, height, stream, font, color_fg, color_bg --> void
#   Modifies status_item array
# provides function free_status_item(): User must call on cleanup
#   void --> void
#   kills status_item['pid']
source "$HOME/.bin/ui/menu_bar/status_items/status_item"

function set_defaults() {
    # create new module with type 'status_item' and name 'battery'
    new_module 'status_item' 'battery'

    # set status item name and stream
    set_status_item_name "$(get_module_name)"
    set_status_item_stream "$(get_module_stream)"

    # set default status item geometry
    select_monitor 'default'
    set_status_item_monitor "$(get_monitor_num)"
    set_status_item_x '0'
    set_status_item_y '20'
    set_status_item_width '0'
    set_status_item_height '40'

    # set status item font and colors
    set_status_item_font 'Source Code Pro:size=7'
    set_status_item_color_fg "$(get_color_lightgrey)"
    set_status_item_color_bg "$(get_color_black)"
}

# sets content
#   color_fg, color_bg --> void
#   Modifies content array
# TODO: add bg formatting
function set_content() {
    # set colors
    local color_state="$(get_color_lightgrey)"
    local color_capacity="$(get_color_lightgrey)"

    # get values
    local state=$(cat /sys/class/power_supply/BAT0/status)
    local capacity=$(cat /sys/class/power_supply/BAT0/capacity)

    # change color based on capacity value
    if [[ "${capacity}" -gt 70 ]]; then
        color_capacity="$(get_color_green)"
    elif [[ "${capacity}" -gt 30 ]]; then
        color_capacity="$(get_color_yellow)"
    else
        color_capacity="$(get_color_red)"
    fi

    # set content
    set_status_item_unformatted "${state} ${capacity}"
    set_status_item_formatted "^fg(${color_state})${state} ^fg(${color_capacity})${capacity}"
}

function set_geometry() {
    # calculate position
    local monitor_width="$(get_monitor_width)"
    local font="$(get_status_item_font)"
    local content="$(get_status_item_unformatted)"
    local width=$(xftwidth "${font}" "-${content}-")
    local height="$(get_status_item_height)"
    local xpadding="$(get_monitor_xpadding)"
    local xposition="$(( ${monitor_width} - ${xpadding} - ${width} ))"
    local yposition="$(get_status_item_y)"

    # update status item geometry
    update_status_item_geometry "${xposition}" "${yposition}" "${width}" "${height}"
}

# run on EXIT
function finish() {
    # kill the status_item
    free_status_item

    # remove temp files
    free_module
}

function main() {
    # set var defaults
    set_defaults

    while
        :
    do
        # update content to be displayed
        set_content

        # update status item geometry
        set_geometry

        # pipe to stream
        pipe_content_to_stream

        # wait for 1 minute
        sleep 60
    done
}
# cleanup on exit
trap finish EXIT

# main
main "$@"
