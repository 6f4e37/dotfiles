#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# backlight
# Description: Bezel UI module to change backlight level
# -----------------------------------------------------------------------------
# Requires:
#   light
# -----------------------------------------------------------------------------
# Useage:      $ ./backlight
# -----------------------------------------------------------------------------

# Source color theme which defines color_{0-15}
source "$HOME/.bin/ui/colors"

# set local colors
color_fg="${color_white}"
color_bg="${color_darkgrey}"
color_ol="${color_black}"

# name of the module
bezel_name='bezel_backlight'

# panel layer
bezel_layer='raise'

# fifo
pipe="/tmp/${bezel_name}.fifo"

# backlight level change percentage
level_percent='5'

# define some arguments passed to dzen to determine size and color.
dzen_args=( -title-name "${bezel_name}" -ta c -w 1000 -h 70 -x 940 -y 690 -fg "${color_fg}" -bg "${color_ol}" -e "onstart=${bezel_layer}" )

# similarly for gdbar
gdbar_args=( -w 990 -h 60 -fg "${color_fg}" -bg "${color_bg}" )

case $1 in
    down)
        light -U "${level_percent}"
        ;;
    up)
        light -A "${level_percent}"
        ;;
    off)
        light -S 0
        exit 0
        ;;
    min)
        light -S 5
        ;;
    max)
        light -S 100
        ;;
    *)
        exit 2
        ;;
esac

# make the bezel
if [[ ! -p "${pipe}" ]]; then
    mkfifo "${pipe}"
    (dzen2 "${dzen_args[@]}" < "$pipe"; rm -f "$pipe") &
fi

# get new backlight level
level="$(light -G)"

# pipe to fifo and wait for capture
(echo "${level}" | gdbar "${gdbar_args[@]}"; sleep 1) >> "$pipe"
