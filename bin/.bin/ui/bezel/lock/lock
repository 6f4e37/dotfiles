#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# lock
# Description: locks screen using i3lock and image generated by imagemagick
# -----------------------------------------------------------------------------
# Source:
#   airblader: https://github.com/Airblader/dotfiles-manjaro
#   Fred Weinhaus: http://www.fmwconcepts.com/imagemagick/pixelize/index.php
#   lock image: https://raw.githubusercontent.com/meskarune/i3lock-fancy/master/lock.png
# -----------------------------------------------------------------------------
# Requires:
#   preferred: i3lock-color, alternative: i3lock
#   scrot
#   imagemagick
#   pixelize script
# -----------------------------------------------------------------------------
# Useage:      $ sh ./lock
# -----------------------------------------------------------------------------

# dependencies
readonly lock_overlay="$(dirname $BASH_SOURCE)/lock.png"
readonly pixelize_script="$(dirname $BASH_SOURCE)/pixelize.sh"

# temporary screenshot
readonly lock_scrot=$( mktemp --tmpdir lock_scrot.png.XXX )

# colors
source "$HOME/.bin/ui/colors"

# run on EXIT
function finish() {
    # remove temp file
    rm -f ${lock_scrot}
}

# pixelates, darkens, and adds overlay to the middle of an image
function edit_image() {
    local img="$1"

    local color_fg="${color_white}"
    local color_bg="${color_black}"

    # image attributes
    local img_width="$( identify -format %[w] ${img} )"
    local img_height="$( identify -format %[h] ${img} )"
    local x_center=$(( ${img_width} / 2 ))
    local y_center=$(( ${img_height} / 2 ))
    local lock_radius=92
    local circle_radius=$(( ${y_center} + ${lock_radius} ))

    # pixelate screenshot
    "${pixelize_script}" -s 5 -m 2 "${img}" "${img}"

    # darken and add lock
    convert "${img}" \
        -scale '20%' -level '-35%' -modulate '40' -scale '500%' \
        -fill "${color_bg}" -stroke "${color_fg}" -draw "fill-opacity 80% circle ${x_center},${y_center},${x_center},${circle_radius}" \
        -gravity 'center' "${lock_overlay}" -composite "${img}"
}

# invokes i3lock-color with correct ui colors
function fancy_lock() {
    local img="$1"

    # need to strip leading '#'
    local color_fg="${color_white#*\#}"
    local color_bg="${color_black#*\#}"
    local color_wrong="${color_red#*\#}"

    i3lock \
        --insidevercolor="${color_fg}20" --insidewrongcolor="${color_wrong}20" \
        --insidecolor="${color_bg}00" --ringvercolor="${color_fg}FF" \
        --ringvercolor="${color_fg}FF" --ringwrongcolor="${color_wrong}FF" \
        --ringcolor="${color_bg}00" --linecolor="${color_fg}00" \
        --textcolor="${color_fg}00" --keyhlcolor="${color_fg}FF" \
        --bshlcolor="${color_wrong}FF" \
        -i "${img}"
}

# cleanup on EXIT
trap finish EXIT

# take screenshot
scrot -d0 "${lock_scrot}"

# edit scrot
edit_image "${lock_scrot}"

# lock with edited scrot
fancy_lock "${lock_scrot}"
