#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# backlight
# Description: Bezel UI module to change keyboard light level
# -----------------------------------------------------------------------------
# Requires:
#   kbdlight
# -----------------------------------------------------------------------------
# Useage:      $ ./keys
# -----------------------------------------------------------------------------

# Source color theme which defines color_{0-15}
source "$HOME/.dotfiles/bin/ui/colors"

# set local colors
color_fg="${color_white}"
color_bg="${color_darkgrey}"
color_ol="${color_black}"

# name of the module
bezel_name='bezel_keys'

# panel layer
bezel_layer='raise'

# fifo
pipe="/tmp/${bezel_name}.fifo"

# light level change percentage (kbdlight 0 - 255)
level_percent='16'

# define some arguments passed to dzen to determine size and color.
dzen_args=( -title-name "${bezel_name}" -ta c -w 1000 -h 70 -x 940 -y 690 -fg "${color_fg}" -bg "${color_ol}" -e "onstart=${bezel_layer}" )

# similarly for gdbar
gdbar_args=( -w 990 -h 60 -fg "${color_fg}" -bg "${color_bg}" )

case $1 in
    down)
        kbdlight down "${level_percent}"
        ;;
    up)
        kbdlight up "${level_percent}"
        ;;
    min)
        kbdlight off
        ;;
    max)
        kbdlight max
        ;;
    *)
        exit 2
        ;;
esac

# make the bezel
if [[ ! -p "${pipe}" ]]; then
    mkfifo "${pipe}"
    (dzen2 "${dzen_args[@]}" < "$pipe"; rm -f "$pipe") &
fi

# get new light level
level="$(kbdlight get)"

# pipe to fifo and wait for capture
(echo "${level/.*/}" 255 | gdbar "${gdbar_args[@]}"; sleep 1) >> "$pipe"
