#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# lock
# Description: locks screen using i3lock and image generated by imagemagick
# -----------------------------------------------------------------------------
# Source:
#   airblader: https://github.com/Airblader/dotfiles-manjaro
#   Fred Weinhaus: http://www.fmwconcepts.com/imagemagick/pixelize/index.php
#   lock image: https://raw.githubusercontent.com/meskarune/i3lock-fancy/master/lock.png
# -----------------------------------------------------------------------------
# Requires:
#   preferred: i3lock-color, alternative: i3lock
#   scrot
#   imagemagick
#   pixelize script
# -----------------------------------------------------------------------------
# Useage:      $ sh ./lock
# -----------------------------------------------------------------------------

set -eu

# user specific
overlay="$(dirname $BASH_SOURCE)/lock.png"
pixelize="$(dirname $BASH_SOURCE)/pixelize.sh"
width=2880
height=1800
overlay_radius=94
screenshot=$( mktemp --tmpdir i3lock-scrot-XXX.png )
lock=$( mktemp --tmpdir i3lock-final-XXX.png )

# math
center_x=$(( ${width} / 2 ))
center_y=$(( ${height} / 2 ))
radius=$(( ${center_y} + ${overlay_radius} ))

# colors
source "$HOME/.dotfiles/bin/ui/colors"
circle_fill="${color_black}"
circle_stroke="${color_white}"

lock() {
    if [[ $1 -eq 0 ]]; then
        # non fancy
        i3lock \
            -u \
            -i "$2"
    elif [[ $1 -eq 1 ]]; then
        i3lock \
            --insidevercolor=c5c8c620 --insidewrongcolor=a5424220 \
            --insidecolor=00000000 --ringvercolor=c5c8c6FF \
            --ringvercolor=c5c8c6FF --ringwrongcolor=a54242FF \
            --ringcolor=00000000 --linecolor=ffffff00 \
            --textcolor=ffffff00 --keyhlcolor=c5c8c6FF \
            --bshlcolor=a54242FF \
            -i "$2"
    else
        echo "Error: Something went wrong" >&2
        exit 1
    fi
}

# take screenshot
scrot -d0 "${screenshot}"

# lock screen immediately with initial screenshot
lock 0 "${screenshot}"

# pixelate screenshot
"${pixelize}" -s 5 -m 2 "${screenshot}" "${screenshot}"

# darken and add lock
convert "${screenshot}" \
    -scale '20%' -level '-35%' -modulate '40' -scale '500%' \
    -fill "${circle_fill}" -stroke "${circle_stroke}" -draw "fill-opacity 80% circle ${center_x},${center_y},${center_x},${radius}" \
    -gravity 'center' "${overlay}" -composite \
    ${lock}

# kills the old lockscreen adds the new edited one
kill $( pgrep i3lock )
lock 1 "${lock}"

trap "rm ${screenshot} ${lock}" EXIT
