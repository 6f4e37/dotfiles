#!/usr/bin/env bash

# -----------------------------------------------------------------------------
# clock
# Description: Displays panel showing information about time
# -----------------------------------------------------------------------------
# Source:
#   onodera-punpun: https://github.com/onodera-punpun/dotfiles
# -----------------------------------------------------------------------------
# Requires:
#   xftwidth
#   dzen
# -----------------------------------------------------------------------------
# Useage:      $ sh ./clock
# -----------------------------------------------------------------------------

# Define colors
color1=$( cat $HOME/.Xresources | grep color6 | tail -c 8 )
color2=$( cat $HOME/.Xresources | grep color3 | tail -c 8 )
color3=$( cat $HOME/.Xresources | grep color7 | tail -c 8 )

# Kill old clocks
pkill -f 'dzen2 -title-name clock'*
sleep 0.1

# Calculate the width
count=$( xftwidth 'Source Code Pro:size=7' "$(date +'%A %d %I:%M %p')" )
width=$(( $count + 30 ))
margin=$(( 1440 - $width / 2 ))

while
    :
do
    time=$( date +"^fg(${color3})%A ^fg(${color1})%d ^fg(${color2})%I^fg(${color3}):^fg(${color2})%M ^fg(${color3})%p" )

    # Reload the clock on day change
    countnew=$( xftwidth 'Source Code Pro:size=7' "$(date +'%A %d %I:%M %p')" )

    if [[ $count -ne $countnew ]]; then
        bash ~/.dotfiles/bin/panels/clock &
        exit 0
    fi

    echo "$time"

    sleep 30
done |

# Spawn clock (dzen/bar)
dzen2 -title-name clock -p -geometry +$margin+25 -fn 'Source Code Pro:size=7' -ta c -w $width -h 40 -e 'onstart=lower' & disown
